# è§†é¢‘ä¸Šä¼ å®Œæ•´æµç¨‹è¯¦è§£ï¼ˆåŸºäºå½“å‰ä»£ç ï¼‰

## ä¸€ã€æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           è§†é¢‘ä¸Šä¼ æ¨¡å—æ¶æ„                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  å‰ç«¯ (web/js/app.js)                    åç«¯ (backend/)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ uploadVideo()       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ routes/routes.go    â”‚               â”‚
â”‚  â”‚ handleFileSelect()  â”‚                 â”‚ controllers/        â”‚               â”‚
â”‚  â”‚ fetchVideoList()    â”‚                 â”‚ services/           â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚ utils/              â”‚               â”‚
â”‚                                          â”‚ models/             â”‚               â”‚
â”‚                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                    â”‚                           â”‚
â”‚                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚                                          â”‚ å¤–éƒ¨æœåŠ¡             â”‚               â”‚
â”‚                                          â”‚ - MinIO å¯¹è±¡å­˜å‚¨     â”‚               â”‚
â”‚                                          â”‚ - MySQL æ•°æ®åº“      â”‚               â”‚
â”‚                                          â”‚ - Redis ç¼“å­˜        â”‚               â”‚
â”‚                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€å®Œæ•´æµç¨‹æ—¶åºå›¾

```
ç”¨æˆ·                å‰ç«¯                    åç«¯                    MinIO        æ•°æ®åº“
 â”‚                   â”‚                      â”‚                      â”‚            â”‚
 â”‚ 1.ç‚¹å‡»ä¸Šä¼ æŒ‰é’®      â”‚                      â”‚                      â”‚            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚                      â”‚            â”‚
 â”‚                   â”‚ openUploadModal()    â”‚                      â”‚            â”‚
 â”‚                   â”‚                      â”‚                      â”‚            â”‚
 â”‚ 2.é€‰æ‹©è§†é¢‘æ–‡ä»¶      â”‚                      â”‚                      â”‚            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚                      â”‚            â”‚
 â”‚                   â”‚ handleFileSelect()   â”‚                      â”‚            â”‚
 â”‚                   â”‚ - éªŒè¯æ ¼å¼å’Œå¤§å°      â”‚                      â”‚            â”‚
 â”‚                   â”‚ - æ˜¾ç¤ºé¢„è§ˆ           â”‚                      â”‚            â”‚
 â”‚                   â”‚                      â”‚                      â”‚            â”‚
 â”‚ 3.ç‚¹å‡»å¼€å§‹ä¸Šä¼       â”‚                      â”‚                      â”‚            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚                      â”‚            â”‚
 â”‚                   â”‚ uploadVideo()        â”‚                      â”‚            â”‚
 â”‚                   â”‚                      â”‚                      â”‚            â”‚
 â”‚                   â”‚ ç¬¬1æ­¥ï¼šè·å–ä¸Šä¼ å‡­è¯   â”‚                      â”‚            â”‚
 â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚            â”‚
 â”‚                   â”‚ POST /api/video/     â”‚ GetUploadURL()       â”‚            â”‚
 â”‚                   â”‚ upload-url           â”‚ â”œâ”€éªŒè¯ç”¨æˆ·            â”‚            â”‚
 â”‚                   â”‚ {filename,filesize,  â”‚ â”œâ”€éªŒè¯æ–‡ä»¶æ ¼å¼        â”‚            â”‚
 â”‚                   â”‚  title}              â”‚ â”œâ”€ç”ŸæˆUUIDæ–‡ä»¶å      â”‚            â”‚
 â”‚                   â”‚                      â”‚ â”œâ”€ç”Ÿæˆé¢„ç­¾åURL â”€â”€â”€â”€â”€â–ºâ”‚            â”‚
 â”‚                   â”‚                      â”‚ â”‚                    â”‚            â”‚
 â”‚                   â”‚                      â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚            â”‚
 â”‚                   â”‚                      â”‚ â””â”€åˆ›å»ºè§†é¢‘è®°å½• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
 â”‚                   â”‚                      â”‚   (status=0ä¸Šä¼ ä¸­)    â”‚            â”‚
 â”‚                   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚            â”‚
 â”‚                   â”‚ {upload_url,video_id}â”‚                      â”‚            â”‚
 â”‚                   â”‚                      â”‚                      â”‚            â”‚
 â”‚                   â”‚ ç¬¬2æ­¥ï¼šç›´ä¼ åˆ°MinIO    â”‚                      â”‚            â”‚
 â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚            â”‚
 â”‚                   â”‚ PUT upload_url       â”‚                      â”‚            â”‚
 â”‚                   â”‚ (è§†é¢‘æ–‡ä»¶äºŒè¿›åˆ¶)      â”‚                      â”‚            â”‚
 â”‚                   â”‚ + è¿›åº¦ç›‘å¬           â”‚                      â”‚            â”‚
 â”‚                   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚            â”‚
 â”‚                   â”‚ HTTP 200 OK          â”‚                      â”‚            â”‚
 â”‚                   â”‚                      â”‚                      â”‚            â”‚
 â”‚                   â”‚ ç¬¬3æ­¥ï¼šç¡®è®¤ä¸Šä¼ å®Œæˆ   â”‚                      â”‚            â”‚
 â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚            â”‚
 â”‚                   â”‚ POST /api/video/     â”‚ ConfirmUpload()      â”‚            â”‚
 â”‚                   â”‚ upload-complete      â”‚ â”œâ”€éªŒè¯ç”¨æˆ·æƒé™        â”‚            â”‚
 â”‚                   â”‚ {video_id}           â”‚ â”œâ”€æ£€æŸ¥æ–‡ä»¶å­˜åœ¨ â”€â”€â”€â”€â”€â”€â–ºâ”‚            â”‚
 â”‚                   â”‚                      â”‚ â”‚                    â”‚            â”‚
 â”‚                   â”‚                      â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚            â”‚
 â”‚                   â”‚                      â”‚ â”œâ”€ç”Ÿæˆæ’­æ”¾URL â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚            â”‚
 â”‚                   â”‚                      â”‚ â”‚                    â”‚            â”‚
 â”‚                   â”‚                      â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚            â”‚
 â”‚                   â”‚                      â”‚ â””â”€æ›´æ–°è§†é¢‘çŠ¶æ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
 â”‚                   â”‚                      â”‚   (status=1ä¸Šä¼ å®Œæˆ)   â”‚            â”‚
 â”‚                   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚            â”‚
 â”‚                   â”‚ {success,video_url}  â”‚                      â”‚            â”‚
 â”‚                   â”‚                      â”‚                      â”‚            â”‚
 â”‚                   â”‚ ç¬¬4æ­¥ï¼šåˆ·æ–°è§†é¢‘åˆ—è¡¨   â”‚                      â”‚            â”‚
 â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚            â”‚
 â”‚                   â”‚ GET /api/videos      â”‚ GetVideoList()       â”‚            â”‚
 â”‚                   â”‚                      â”‚ â””â”€æŸ¥è¯¢è§†é¢‘åˆ—è¡¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
 â”‚                   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚            â”‚
 â”‚                   â”‚ {videos,total,page}  â”‚                      â”‚            â”‚
 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚                      â”‚            â”‚
 â”‚ ä¸Šä¼ æˆåŠŸï¼Œæ˜¾ç¤ºæ–°è§†é¢‘ â”‚                      â”‚                      â”‚            â”‚
```

---

## ä¸‰ã€è¯¦ç»†å‡½æ•°è°ƒç”¨é“¾

### ğŸ”¥ ç¬¬1æ­¥ï¼šè·å–ä¸Šä¼ å‡­è¯

```
ã€å‰ç«¯ã€‘uploadVideo() 
    â†“ å‘é€è¯·æ±‚
ã€HTTPã€‘POST /api/video/upload-url
    â†“ è·¯ç”±åˆ†å‘
ã€è·¯ç”±ã€‘routes.SetupRoutes() â†’ protected.POST("/video/upload-url", controllers.GetUploadURL)
    â†“ ä¸­é—´ä»¶éªŒè¯
ã€ä¸­é—´ä»¶ã€‘middlewares.AuthMiddleware() â†’ éªŒè¯JWTï¼Œæå–usernameåˆ°Context
    â†“ æ§åˆ¶å™¨å¤„ç†
ã€æ§åˆ¶å™¨ã€‘controllers.GetUploadURL(c *gin.Context)
    â”‚
    â”œâ”€ c.Get("username") â†’ è·å–ç”¨æˆ·å
    â”œâ”€ c.ShouldBindJSON(&req) â†’ è§£æè¯·æ±‚å‚æ•°
    â”‚   â””â”€ req: UploadURLRequest {
    â”‚       Filename: "æˆ‘çš„è§†é¢‘.mp4"
    â”‚       Filesize: 52428800
    â”‚       Title: "æˆ‘çš„ç¬¬ä¸€ä¸ªè§†é¢‘"
    â”‚   }
    â””â”€ videoService.GetUploadURL(username, req) â†’ è°ƒç”¨æœåŠ¡å±‚
        â†“
ã€æœåŠ¡å±‚ã€‘services.VideoService.GetUploadURL(username string, req UploadURLRequest) (*UploadURLResponse, error)
    â”‚
    â”œâ”€ utils.GetUserByUsername(username) â†’ è·å–ç”¨æˆ·ä¿¡æ¯
    â”‚   â””â”€ è¿”å›: *models.User{ID: 1, Username: "å¼ ä¸‰", ...}
    â”‚
    â”œâ”€ éªŒè¯æ–‡ä»¶æ ¼å¼: allowedVideoFormats[".mp4"] = true âœ“
    â”œâ”€ éªŒè¯æ–‡ä»¶å¤§å°: 52428800 â‰¤ 500*1024*1024 âœ“
    â”œâ”€ ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å: uuid.New().String() + ".mp4"
    â”‚   â””â”€ ç»“æœ: "a1b2c3d4-e5f6-7890-abcd-ef1234567890.mp4"
    â”‚
    â”œâ”€ utils.GenerateUploadURL(uniqueFilename) â†’ ç”ŸæˆMinIOé¢„ç­¾åURL
    â”‚   â””â”€ è°ƒç”¨MinIO SDK: mc.PresignedPutObject(ctx, "cwatch", filename, 15åˆ†é’Ÿ)
    â”‚   â””â”€ è¿”å›: "http://101.132.25.34:9000/cwatch/a1b2c3d4...?X-Amz-Algorithm=..."
    â”‚
    â”œâ”€ åˆ›å»ºè§†é¢‘è®°å½•: utils.CreateVideo(&models.Video{
    â”‚       Title: "æˆ‘çš„ç¬¬ä¸€ä¸ªè§†é¢‘",
    â”‚       UserID: 1,
    â”‚       Status: 0, // VideoStatusUploading
    â”‚       FileName: "a1b2c3d4-e5f6-7890-abcd-ef1234567890.mp4"
    â”‚   })
    â”‚   â””â”€ æ‰§è¡ŒSQL: INSERT INTO videos (...) VALUES (...)
    â”‚   â””â”€ è‡ªåŠ¨ç”ŸæˆID: video.ID = 1
    â”‚
    â””â”€ è¿”å›: &UploadURLResponse{
        UploadURL: "http://101.132.25.34:9000/cwatch/a1b2c3d4...?X-Amz-...",
        VideoID: 1
    }
        â†“
ã€æ§åˆ¶å™¨ã€‘c.JSON(200, resp) â†’ è¿”å›HTTPå“åº”
        â†“
ã€å‰ç«¯ã€‘const { upload_url, video_id } = await urlRes.json()
    â””â”€ upload_url: "http://101.132.25.34:9000/cwatch/a1b2c3d4...?X-Amz-..."
    â””â”€ video_id: 1
```

### ğŸ”¥ ç¬¬2æ­¥ï¼šç›´ä¼ æ–‡ä»¶åˆ°MinIO

```
ã€å‰ç«¯ã€‘uploadVideo() ç»§ç»­æ‰§è¡Œ
    â†“
ã€XMLHttpRequestã€‘ç›´æ¥ä¸Šä¼ åˆ°MinIO
    â”‚
    â”œâ”€ URL: upload_url (é¢„ç­¾åURL)
    â”œâ”€ æ–¹æ³•: PUT
    â”œâ”€ è¯·æ±‚ä½“: state.uploadFile (è§†é¢‘æ–‡ä»¶äºŒè¿›åˆ¶æ•°æ®)
    â”œâ”€ è¿›åº¦ç›‘å¬: xhr.upload.addEventListener("progress", ...)
    â”‚   â””â”€ æ›´æ–°è¿›åº¦æ¡: el.uploadProgressFill.style.width = percent + "%"
    â”‚
    â””â”€ ç›´æ¥å‘é€åˆ°MinIOæœåŠ¡å™¨ (101.132.25.34:9000)
        â†“
ã€MinIOæœåŠ¡å™¨ã€‘æ¥æ”¶å¹¶å­˜å‚¨æ–‡ä»¶
    â”‚
    â”œâ”€ å­˜å‚¨æ¡¶: "cwatch"
    â”œâ”€ æ–‡ä»¶å: "a1b2c3d4-e5f6-7890-abcd-ef1234567890.mp4"
    â”œâ”€ æ–‡ä»¶å¤§å°: 52428800 å­—èŠ‚
    â”‚
    â””â”€ è¿”å›: HTTP 200 OK
        â†“
ã€å‰ç«¯ã€‘xhr.onload â†’ ä¸Šä¼ å®Œæˆ
```

### ğŸ”¥ ç¬¬3æ­¥ï¼šç¡®è®¤ä¸Šä¼ å®Œæˆ

```
ã€å‰ç«¯ã€‘uploadVideo() ç»§ç»­æ‰§è¡Œ
    â†“ å‘é€ç¡®è®¤è¯·æ±‚
ã€HTTPã€‘POST /api/video/upload-complete
    â†“
ã€æ§åˆ¶å™¨ã€‘controllers.ConfirmUpload(c *gin.Context)
    â”‚
    â”œâ”€ c.Get("username") â†’ è·å–ç”¨æˆ·å
    â”œâ”€ c.ShouldBindJSON(&req) â†’ è§£æè¯·æ±‚å‚æ•°
    â”‚   â””â”€ req: ConfirmUploadRequest { VideoID: 1 }
    â””â”€ videoService.ConfirmUpload(username, req) â†’ è°ƒç”¨æœåŠ¡å±‚
        â†“
ã€æœåŠ¡å±‚ã€‘services.VideoService.ConfirmUpload(username string, req ConfirmUploadRequest) (*ConfirmUploadResponse, error)
    â”‚
    â”œâ”€ utils.GetUserByUsername(username) â†’ è·å–ç”¨æˆ·ä¿¡æ¯
    â”‚   â””â”€ è¿”å›: *models.User{ID: 1, Username: "å¼ ä¸‰", ...}
    â”‚
    â”œâ”€ utils.GetVideoByID(req.VideoID) â†’ æŸ¥è¯¢è§†é¢‘è®°å½•
    â”‚   â””â”€ æ‰§è¡ŒSQL: SELECT * FROM videos WHERE id = 1
    â”‚   â””â”€ è¿”å›: *models.Video{ID: 1, UserID: 1, Status: 0, FileName: "a1b2c3d4...mp4"}
    â”‚
    â”œâ”€ éªŒè¯è§†é¢‘æ‰€æœ‰æƒ: video.UserID == user.ID âœ“
    â”œâ”€ éªŒè¯è§†é¢‘çŠ¶æ€: video.Status == VideoStatusUploading âœ“
    â”‚
    â”œâ”€ utils.CheckFileExists(video.FileName) â†’ æ£€æŸ¥MinIOä¸­æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    â”‚   â””â”€ è°ƒç”¨MinIO SDK: mc.StatObject(ctx, "cwatch", filename, ...)
    â”‚   â””â”€ è¿”å›: true (æ–‡ä»¶å­˜åœ¨)
    â”‚
    â”œâ”€ utils.GenerateDownloadURL(video.FileName) â†’ ç”Ÿæˆè§†é¢‘æ’­æ”¾URL
    â”‚   â””â”€ è°ƒç”¨MinIO SDK: mc.PresignedGetObject(ctx, "cwatch", filename, 24å°æ—¶, ...)
    â”‚   â””â”€ è¿”å›: "http://101.132.25.34:9000/cwatch/a1b2c3d4...?X-Amz-Algorithm=..."
    â”‚
    â”œâ”€ utils.UpdateVideo(video.ID, map[string]interface{}{
    â”‚       "status": 1, // VideoStatusUploaded
    â”‚       "url": videoURL
    â”‚   })
    â”‚   â””â”€ æ‰§è¡ŒSQL: UPDATE videos SET status=1, url='...' WHERE id=1
    â”‚
    â””â”€ è¿”å›: &ConfirmUploadResponse{
        Success: true,
        VideoURL: "http://101.132.25.34:9000/cwatch/a1b2c3d4...?X-Amz-..."
    }
        â†“
ã€å‰ç«¯ã€‘ä¸Šä¼ æˆåŠŸå¤„ç†
    â”œâ”€ toast("è§†é¢‘ä¸Šä¼ æˆåŠŸï¼")
    â”œâ”€ state.isUploading = false
    â””â”€ setTimeout 1.5ç§’å:
        â”œâ”€ closeUploadModal()
        â””â”€ fetchVideoList(1, false) â†’ é‡æ–°åŠ è½½è§†é¢‘åˆ—è¡¨
```

### ğŸ”¥ ç¬¬4æ­¥ï¼šåˆ·æ–°è§†é¢‘åˆ—è¡¨

```
ã€å‰ç«¯ã€‘fetchVideoList(page, append)
    â†“ å‘é€è¯·æ±‚
ã€HTTPã€‘GET /api/videos?page=1&page_size=12
    â†“
ã€æ§åˆ¶å™¨ã€‘controllers.GetVideoList(c *gin.Context)
    â”‚
    â”œâ”€ page, _ := strconv.Atoi(c.DefaultQuery("page", "1")) â†’ 1
    â”œâ”€ pageSize, _ := strconv.Atoi(c.DefaultQuery("page_size", "12")) â†’ 12
    â””â”€ videoService.GetVideoList(page, pageSize) â†’ è°ƒç”¨æœåŠ¡å±‚
        â†“
ã€æœåŠ¡å±‚ã€‘services.VideoService.GetVideoList(page, pageSize int) (*VideoListResponse, error)
    â”‚
    â”œâ”€ å‚æ•°éªŒè¯å’Œé™åˆ¶
    â””â”€ utils.GetVideoList(page, pageSize) â†’ è°ƒç”¨å·¥å…·å±‚
        â†“
ã€å·¥å…·å±‚ã€‘utils.GetVideoList(page, pageSize int) ([]VideoListItem, int64, error)
    â”‚
    â”œâ”€ æŸ¥è¯¢æ€»æ•°: db.Model(&Video{}).Where("status = ?", 1).Count(&total)
    â”œâ”€ åˆ†é¡µæŸ¥è¯¢: db.Where("status = ?", 1).Order("created_at DESC").Offset((page-1)*pageSize).Limit(pageSize).Find(&videos)
    â”œâ”€ å…³è”æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯: db.First(&user, video.UserID)
    â”œâ”€ ç»Ÿè®¡ç‚¹èµæ•°: db.Model(&Like{}).Where("video_id = ?", video.ID).Count(&likeCount)
    â”œâ”€ ç»Ÿè®¡è¯„è®ºæ•°: db.Model(&Comment{}).Where("video_id = ?", video.ID).Count(&commentCount)
    â”‚
    â””â”€ è¿”å›: []VideoListItem{
        {
            ID: 1,
            Title: "æˆ‘çš„ç¬¬ä¸€ä¸ªè§†é¢‘",
            URL: "http://101.132.25.34:9000/cwatch/a1b2c3d4...?X-Amz-...",
            Username: "å¼ ä¸‰",
            Likes: 0,
            Comments: 0,
            CreatedAt: "2026-01-17 15:30"
        }
    }, total: 1
        â†“
ã€å‰ç«¯ã€‘renderPreviewGrid(videos) â†’ æ¸²æŸ“è§†é¢‘é¢„è§ˆå¡ç‰‡
    â””â”€ ç”¨æˆ·å¯ä»¥åœ¨é¦–é¡µçœ‹åˆ°åˆšä¸Šä¼ çš„è§†é¢‘
```

---

## å››ã€æ•°æ®ç»“æ„è¯¦è§£

### ğŸ“‹ è¯·æ±‚/å“åº”ç»“æ„

```go
// 1. è·å–ä¸Šä¼ URL - è¯·æ±‚
type UploadURLRequest struct {
    Filename string `json:"filename" binding:"required"` // åŸå§‹æ–‡ä»¶åï¼Œå¦‚"æˆ‘çš„è§†é¢‘.mp4"
    Filesize int64  `json:"filesize" binding:"required"` // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰ï¼Œå¦‚52428800
    Title    string `json:"title"`                       // è§†é¢‘æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰ï¼Œå¦‚"æˆ‘çš„ç¬¬ä¸€ä¸ªè§†é¢‘"
}

// 1. è·å–ä¸Šä¼ URL - å“åº”
type UploadURLResponse struct {
    UploadURL string `json:"upload_url"` // é¢„ç­¾åä¸Šä¼ URLï¼Œ15åˆ†é’Ÿæœ‰æ•ˆæœŸ
    VideoID   uint   `json:"video_id"`   // æ•°æ®åº“ä¸­çš„è§†é¢‘ID
}

// 2. ç¡®è®¤ä¸Šä¼ å®Œæˆ - è¯·æ±‚
type ConfirmUploadRequest struct {
    VideoID uint `json:"video_id" binding:"required"` // è§†é¢‘ID
}

// 2. ç¡®è®¤ä¸Šä¼ å®Œæˆ - å“åº”
type ConfirmUploadResponse struct {
    Success  bool   `json:"success"`   // æ˜¯å¦æˆåŠŸ
    VideoURL string `json:"video_url"` // è§†é¢‘æ’­æ”¾URLï¼Œ24å°æ—¶æœ‰æ•ˆæœŸ
}

// 3. è§†é¢‘åˆ—è¡¨ - å“åº”
type VideoListResponse struct {
    Videos   []VideoListItem `json:"videos"`    // è§†é¢‘åˆ—è¡¨
    Total    int64           `json:"total"`     // æ€»æ•°
    Page     int             `json:"page"`      // å½“å‰é¡µ
    PageSize int             `json:"page_size"` // æ¯é¡µæ•°é‡
}

type VideoListItem struct {
    ID          uint   `json:"id"`          // è§†é¢‘ID
    Title       string `json:"title"`       // è§†é¢‘æ ‡é¢˜
    URL         string `json:"url"`         // è§†é¢‘æ’­æ”¾URL
    Username    string `json:"username"`    // ä½œè€…ç”¨æˆ·å
    Likes       int64  `json:"likes"`       // ç‚¹èµæ•°
    Comments    int64  `json:"comments"`    // è¯„è®ºæ•°
    CreatedAt   string `json:"created_at"`  // åˆ›å»ºæ—¶é—´
}
```

### ğŸ“‹ æ•°æ®åº“æ¨¡å‹

```go
// è§†é¢‘æ¨¡å‹
type Video struct {
    gorm.Model                                    // ID, CreatedAt, UpdatedAt, DeletedAt
    Title       string `gorm:"not null"`         // è§†é¢‘æ ‡é¢˜
    Description string                           // è§†é¢‘æè¿°
    URL         string                           // è§†é¢‘æ’­æ”¾URLï¼ˆé¢„ç­¾åURLï¼‰
    CoverURL    string                           // è§†é¢‘å°é¢å›¾URL
    UserID      uint                             // è§†é¢‘æ‰€å±ç”¨æˆ·ID
    Status      int    `gorm:"default:0"`        // è§†é¢‘çŠ¶æ€
    FileName    string                           // å­˜å‚¨çš„æ–‡ä»¶åï¼ˆUUIDç”Ÿæˆï¼‰
}

// è§†é¢‘çŠ¶æ€å¸¸é‡
const (
    VideoStatusUploading  = 0 // ä¸Šä¼ ä¸­
    VideoStatusUploaded   = 1 // ä¸Šä¼ å®Œæˆ
    VideoStatusProcessing = 2 // è½¬ç ä¸­
    VideoStatusPublished  = 3 // å·²å‘å¸ƒ
    VideoStatusFailed     = 4 // å®¡æ ¸å¤±è´¥
)
```

---

## äº”ã€å…³é”®é…ç½®å‚æ•°

### ğŸ”§ MinIOé…ç½®

```go
const (
    MinioBucket       = "cwatch"                 // å­˜å‚¨æ¡¶åç§°
    MinioEndpoint     = "101.132.25.34:9000"    // MinIOæœåŠ¡åœ°å€
    UploadURLExpiry   = 15 * time.Minute        // ä¸Šä¼ URLæœ‰æ•ˆæœŸï¼ˆ15åˆ†é’Ÿï¼‰
    DownloadURLExpiry = 24 * time.Hour          // ä¸‹è½½URLæœ‰æ•ˆæœŸï¼ˆ24å°æ—¶ï¼‰
)

// MinIOå‡­è¯
accessKeyID := "minioadmin"
secretAccessKey := "minio030303"
```

### ğŸ”§ æ–‡ä»¶é™åˆ¶

```go
// å…è®¸çš„è§†é¢‘æ ¼å¼
var allowedVideoFormats = map[string]bool{
    ".mp4":  true,
    ".webm": true,
    ".mov":  true,
    ".avi":  true,
    ".mkv":  true,
}

// æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆ500MBï¼‰
const MaxFileSize = 500 * 1024 * 1024
```

---

## å…­ã€é”™è¯¯å¤„ç†æœºåˆ¶

### ğŸš¨ å¸¸è§é”™è¯¯åŠå¤„ç†

| é”™è¯¯åœºæ™¯ | æ£€æŸ¥ä½ç½® | é”™è¯¯ä¿¡æ¯ | å¤„ç†æ–¹å¼ |
|---------|---------|---------|---------|
| ç”¨æˆ·æœªç™»å½• | Controller | "æœªæˆæƒ" | è¿”å›401ï¼Œå‰ç«¯è·³è½¬ç™»å½•é¡µ |
| æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒ | Service | "ä¸æ”¯æŒçš„è§†é¢‘æ ¼å¼" | è¿”å›400ï¼Œå‰ç«¯æ˜¾ç¤ºé”™è¯¯æç¤º |
| æ–‡ä»¶è¿‡å¤§ | Service | "æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶" | è¿”å›400ï¼Œå‰ç«¯æ˜¾ç¤ºé”™è¯¯æç¤º |
| MinIOè¿æ¥å¤±è´¥ | Utils | "ç”Ÿæˆä¸Šä¼ URLå¤±è´¥" | è¿”å›500ï¼Œå‰ç«¯æ˜¾ç¤ºç½‘ç»œé”™è¯¯ |
| æ•°æ®åº“æ“ä½œå¤±è´¥ | Utils | "åˆ›å»ºè§†é¢‘è®°å½•å¤±è´¥" | è¿”å›500ï¼Œå‰ç«¯æ˜¾ç¤ºç³»ç»Ÿé”™è¯¯ |
| æ–‡ä»¶æœªä¸Šä¼ æˆåŠŸ | Service | "æ–‡ä»¶æœªä¸Šä¼ æˆåŠŸ" | è¿”å›400ï¼Œå‰ç«¯æç¤ºé‡æ–°ä¸Šä¼  |
| æ— æƒæ“ä½œè§†é¢‘ | Service | "æ— æƒæ“ä½œæ­¤è§†é¢‘" | è¿”å›403ï¼Œå‰ç«¯æ˜¾ç¤ºæƒé™é”™è¯¯ |

---

## ä¸ƒã€æ€§èƒ½ä¼˜åŒ–è¦ç‚¹

### âš¡ è®¾è®¡ä¼˜åŠ¿

1. **ç›´ä¼ MinIO**ï¼šå‰ç«¯ç›´æ¥ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨ï¼Œä¸ç»è¿‡åç«¯ï¼Œå‡è½»æœåŠ¡å™¨å¸¦å®½å‹åŠ›
2. **é¢„ç­¾åURL**ï¼šå®‰å…¨ä¸”é«˜æ•ˆï¼Œé¿å…åœ¨åç«¯ä¸­è½¬å¤§æ–‡ä»¶
3. **çŠ¶æ€ç®¡ç†**ï¼šé€šè¿‡æ•°æ®åº“çŠ¶æ€å­—æ®µç®¡ç†ä¸Šä¼ ç”Ÿå‘½å‘¨æœŸ
4. **åˆ†å±‚æ¶æ„**ï¼šController â†’ Service â†’ Utilsï¼ŒèŒè´£æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
5. **é”™è¯¯å¤„ç†**ï¼šæ¯å±‚éƒ½æœ‰å®Œå–„çš„é”™è¯¯å¤„ç†å’ŒéªŒè¯

### âš¡ å¯ä¼˜åŒ–ç‚¹

1. **æ–‡ä»¶å»é‡**ï¼šå¯ä»¥é€šè¿‡æ–‡ä»¶MD5é¿å…é‡å¤ä¸Šä¼ 
2. **æ–­ç‚¹ç»­ä¼ **ï¼šå¤§æ–‡ä»¶ä¸Šä¼ æ”¯æŒæ–­ç‚¹ç»­ä¼ 
3. **å¼‚æ­¥å¤„ç†**ï¼šä¸Šä¼ å®Œæˆåå¯ä»¥å¼‚æ­¥ç”Ÿæˆç¼©ç•¥å›¾ã€è½¬ç ç­‰
4. **ç¼“å­˜ä¼˜åŒ–**ï¼šè§†é¢‘åˆ—è¡¨å¯ä»¥åŠ å…¥Redisç¼“å­˜
5. **CDNåŠ é€Ÿ**ï¼šMinIOå‰é¢å¯ä»¥åŠ CDNæå‡è®¿é—®é€Ÿåº¦

---

## å…«ã€æ€»ç»“

è¿™ä¸ªè§†é¢‘ä¸Šä¼ æ¨¡å—é‡‡ç”¨äº†**é¢„ç­¾åURL + ç›´ä¼ **çš„ç»å…¸æ¶æ„ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

âœ… **å®‰å…¨æ€§**ï¼šJWTè®¤è¯ + é¢„ç­¾åURL + ç”¨æˆ·æƒé™éªŒè¯  
âœ… **æ€§èƒ½**ï¼šå‰ç«¯ç›´ä¼ MinIOï¼Œä¸å ç”¨åç«¯å¸¦å®½  
âœ… **å¯é æ€§**ï¼šä¸‰æ­¥ç¡®è®¤æœºåˆ¶ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§  
âœ… **å¯æ‰©å±•æ€§**ï¼šåˆ†å±‚æ¶æ„ï¼Œä¾¿äºåç»­åŠŸèƒ½æ‰©å±•  
âœ… **ç”¨æˆ·ä½“éªŒ**ï¼šå®æ—¶è¿›åº¦æ˜¾ç¤º + è‡ªåŠ¨åˆ·æ–°åˆ—è¡¨