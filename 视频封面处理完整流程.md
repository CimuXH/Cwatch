# 视频封面处理完整流程

## 一、整体架构（5个步骤）

```
1. 用户上传视频 → MinIO
2. 后端确认 → 发送消息到 RabbitMQ
3. Worker 接收消息
4. Worker 处理：下载 → 生成封面 → 上传 → 更新数据库
5. 完成！
```

---

## 二、核心流程（3个角色）

## 二、核心流程（3个角色）

### 角色1：后端 API（生产者）
**文件：** `backend/services/video_service.go`

**做什么：** 视频上传完成后，发送任务到队列

```go
// 核心代码
utils.PublishVideoTask(video.ID, video.FileName)
```

**发送的消息：**
```json
{
  "video_id": 1,
  "file_name": "uuid.mp4"
}
```

---

### 角色2：RabbitMQ（消息队列）
**做什么：** 存储任务消息，分发给 Worker

**队列名称：** `video_processing`

**特点：**
- 消息持久化（重启不丢失）
- 自动负载均衡（多个 Worker 公平分发）

---

### 角色3：Worker（消费者）
**文件：** `worker/main.go`

**做什么：** 监听队列，处理视频生成封面

**处理步骤：**
```
1. 从 MinIO 下载视频到本地
2. 用 FFmpeg 生成封面图
3. 上传封面图到 MinIO
4. 更新数据库（保存封面 URL）
5. 删除临时文件
```

---

## 三、关键技术点（必须理解）

### 1. 为什么使用消息队列？

**问题：** 生成封面很慢（30秒），用户要等很久

**解决：** 
- 视频上传完立即返回 ✅
- 封面生成在后台异步处理 ✅

### 2. 手动确认机制

```go
// Worker 处理完才确认
d.Ack(false)  // 成功

// 处理失败，重新入队
d.Nack(false, true)  // 失败，重试
```

**为什么？** 防止消息丢失

### 3. QoS 设置

```go
ch.Qos(1, 0, false)  // 每个 Worker 一次只处理1个任务
```

**为什么？** 实现公平分发

---

## 四、多 Worker 并行处理

### 如何启动多个 Worker？

```bash
# 终端1
go run worker/main.go

# 终端2
go run worker/main.go

# 终端3
go run worker/main.go
```

### 消息如何分发？

```
队列: [任务1] [任务2] [任务3] [任务4] [任务5] [任务6]

Worker 1: 处理 任务1 → 任务4
Worker 2: 处理 任务2 → 任务5
Worker 3: 处理 任务3 → 任务6
```

**结果：** 速度提升3倍！

---

## 五、错误处理

### Worker 处理失败怎么办？

```go
if err != nil {
    d.Nack(false, true)  // 重新入队，其他 Worker 可以重试
}
```

### Worker 崩溃怎么办？

- 未确认的消息自动重新入队
- 其他 Worker 继续处理

---

## 六、完整流程图（简化版）

```
用户上传视频
    ↓
后端：发送消息到队列
    ↓
RabbitMQ：存储消息
    ↓
Worker：接收消息
    ↓
Worker：下载视频
    ↓
Worker：FFmpeg 生成封面
    ↓
Worker：上传封面
    ↓
Worker：更新数据库
    ↓
Worker：确认消息
    ↓
完成！
```

---

## 七、核心代码位置

| 功能 | 文件 | 函数 |
|------|------|------|
| 发送消息 | `backend/utils/rabbitmq.go` | `PublishVideoTask()` |
| 调用发送 | `backend/services/video_service.go` | `ConfirmUpload()` |
| 接收消息 | `worker/main.go` | `main()` |
| 处理视频 | `worker/main.go` | `processVideo()` |

---

## 八、总结（记住这5点）

1. **异步处理**：上传完立即返回，不用等待
2. **解耦**：后端和 Worker 独立，互不影响
3. **可扩展**：可以启动多个 Worker 提速
4. **可靠**：消息不会丢失，失败可重试
5. **容错**：单个 Worker 崩溃不影响整体
